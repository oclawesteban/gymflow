generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          Role      @default(OWNER)
  photoUrl          String?
  bio               String?
  phone             String?
  passwordChangedAt DateTime?
  gym               Gym?
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum PlanTier {
  FREE
  BASIC
  PRO
  MULTI
}

model Gym {
  id            String        @id @default(cuid())
  gymCode       String        @unique
  accessApiKey  String?       @unique  // Clave secreta para ESP32
  name          String
  planTier      PlanTier      @default(FREE)
  planExpiresAt DateTime?
  address      String?
  phone        String?
  whatsapp     String?
  contactEmail String?
  description  String?
  logoUrl      String?
  city         String?
  ownerId      String       @unique
  owner        User         @relation(fields: [ownerId], references: [id])
  members      Member[]
  plans        Plan[]
  classes      GymClass[]
  promoCodes   PromoCode[]
  instructors  Instructor[]
  accessGrants AccessGrant[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model Member {
  id               String         @id @default(cuid())
  name             String
  email            String?
  phone            String?
  photoUrl         String?
  idType           String?        // CC, CE, TI, PA
  idNumber         String?        // Número de documento
  hasEps           Boolean        @default(false)
  epsName          String?        // Nombre de la EPS
  emergencyContact String?
  emergencyPhone   String?
  notes            String?
  portalEmail      String?        @unique
  portalPassword   String?
  gymId            String
  gym              Gym            @relation(fields: [gymId], references: [id], onDelete: Cascade)
  memberships      Membership[]
  attendance       Attendance[]
  bookings         ClassBooking[]
  accessGrants     AccessGrant[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model Plan {
  id           String       @id @default(cuid())
  name         String
  description  String?
  price        Decimal      @db.Decimal(10, 2)
  durationDays Int
  isActive     Boolean      @default(true)
  gymId        String
  gym          Gym          @relation(fields: [gymId], references: [id], onDelete: Cascade)
  memberships  Membership[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model Membership {
  id          String           @id @default(cuid())
  memberId    String
  planId      String
  startDate   DateTime
  endDate     DateTime
  status      MembershipStatus @default(ACTIVE)
  notes       String?
  frozenAt    DateTime?
  frozenUntil DateTime?
  member      Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)
  plan        Plan             @relation(fields: [planId], references: [id])
  payments    Payment[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Payment {
  id             String        @id @default(cuid())
  membershipId   String
  amount         Decimal       @db.Decimal(10, 2)
  method         PaymentMethod @default(CASH)
  reference      String?
  notes          String?
  promoCodeId    String?
  discountAmount Decimal?      @db.Decimal(10, 2)
  paidAt         DateTime      @default(now())
  membership     Membership    @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  promoCode      PromoCode?    @relation(fields: [promoCodeId], references: [id])
  createdAt      DateTime      @default(now())
}

model Attendance {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  checkedIn DateTime @default(now())
  notes     String?
  createdAt DateTime @default(now())
}

model GymClass {
  id           String         @id @default(cuid())
  gymId        String
  gym          Gym            @relation(fields: [gymId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  instructor   String?
  instructorId String?
  instructorRel Instructor?   @relation(fields: [instructorId], references: [id])
  capacity     Int            @default(20)
  dayOfWeek    Int            // 0=Domingo, 1=Lunes, ... 6=Sábado
  startTime    String         // "07:00"
  endTime      String         // "08:00"
  color        String         @default("#3B82F6")
  isActive     Boolean        @default(true)
  bookings     ClassBooking[]
  createdAt    DateTime       @default(now())
}

model ClassBooking {
  id        String   @id @default(cuid())
  classId   String
  gymClass  GymClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  date      DateTime // Fecha específica de la clase
  status    String   @default("CONFIRMED") // CONFIRMED, CANCELLED
  createdAt DateTime @default(now())

  @@unique([classId, memberId, date])
}

model PromoCode {
  id            String    @id @default(cuid())
  gymId         String
  gym           Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  code          String
  description   String?
  discountType  String    // "PERCENTAGE" | "FIXED"
  discountValue Decimal   @db.Decimal(10, 2)
  maxUses       Int?
  usedCount     Int       @default(0)
  validFrom     DateTime  @default(now())
  validUntil    DateTime?
  isActive      Boolean   @default(true)
  payments      Payment[]
  createdAt     DateTime  @default(now())
}

model Instructor {
  id        String     @id @default(cuid())
  gymId     String
  gym       Gym        @relation(fields: [gymId], references: [id], onDelete: Cascade)
  name      String
  email     String?
  phone     String?
  photoUrl  String?
  idType    String?    // CC, CE, TI, PA
  idNumber  String?    // Número de documento
  hasEps    Boolean    @default(false)
  epsName   String?    // Nombre de la EPS
  specialty String?
  bio       String?
  isActive  Boolean    @default(true)
  classes   GymClass[]
  createdAt DateTime   @default(now())
}

enum Role {
  OWNER
  STAFF
  ADMIN
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  PENDING
  CANCELLED
  FROZEN
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  NEQUI
  DAVIPLATA
  OTHER
}

model AccessGrant {
  id        String    @id @default(cuid())
  gymId     String
  memberId  String
  gym       Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  member    Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  expiresAt DateTime  // TTL de 30 segundos
  usedAt    DateTime? // null = pendiente, DateTime = ya usado
  createdAt DateTime  @default(now())
}
